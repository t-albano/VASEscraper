---
title: "data_cleaning"
author: "Trenten"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(data.table)
library(tidyverse)
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
```

**Data Wrangling**: The following tasks with be completed:

- Clean data collected from webscraping VASE website. 
- Left join VASE dataset with TEA's dataset. 
- Lastly, join new data setsets with geospatial data.

VASE and TEA data will be simultaneously worked on. Geospatial data will be incorpated at the very end.

```{r message = FALSE}
vase <- fread("VASE_rawdata.csv")
tea22 <- fread("TEA22_rawdata.csv")
```

**Data Setup**: Datasets will be manipulated to only contain values of interest. Obviously unuseable names (that are not a school or too vague for identification purposes) that cannot be linked to a high school will be discarded.

```{r}
# check variable names
colnames(vase)
colnames(tea22)

# check for extremely unusual values
unique(vase$School)

# rename column names
vase <- vase %>%
  select(-c("Student", "Title")) %>%
  rename("Art_Region" = Region) %>%
  mutate("Region" = NA) %>%
  filter(!School %in% c("Gandrews@aledo.k12.tx.us", "Home School",
                        "Homeschool/seton Home Study", "High School",
                        "High School, Junior H S"))

tea22 <- tea22 %>%
  select(CAMPNAME, CPE0312C,
         GRDHIGH, REGION, DISTNAME) %>%
  rename("School" = CAMPNAME,
         "Enrolled" = CPE0312C,
         "Highest_Grade" = GRDHIGH,
         "Region" = REGION,
         "District" = DISTNAME) %>%
  filter(Highest_Grade %in% c(9, 10, 11, 12)) #reduce size of df and repetitiveness of school names

```

**Preliminary Data Standardization**: School names in `vase` will be somewhat standardized. Region information will also be standardized. This preliminary standardizations will assist with later fuzzy joining.

```{r}
# standardize Region distinctions
# remove subgrouping of region to match with TEA
for (i in (1:length(vase$Art_Region))){
  if (substring(vase$Art_Region[i], nchar(vase$Art_Region[i]),nchar(vase$Art_Region[i])) %in% c("N", "E", "S", "W")){
    vase$Region[i] <- substring(vase$Art_Region[i],1,nchar(vase$Art_Region[i])-1)
  }
  else{
    vase$Region[i] <- vase$Art_Region[i]
  }
}

# remove leading zeros and apostrophe of Region to match with VASE
for (i in (1:length(tea22$Region))){
  tea22$Region[i] <- gsub("^\\'0|^\\'", "", tea22$Region[i])
}

# standardize VASE HS names in similar format as TEA22
# clean HS and ECHS at end of names first

# function to clean up endings
re_string <- function(vect, suffixes, ending){
  column <- vect
  for (i in suffixes){
    for (j in 1:length(column)){
      word <- paste("",i)
      if(word == substring(column[j],nchar(column[j])-nchar(word)+1,nchar(column[j]))){
        a = substring(column[j],1,nchar(column[j])-nchar(word))
        column[j] <- paste0(a, ending)
      }
    }
  }
  return(column)
}

un_string <- function(vect, suffixes){
  column <- vect
  for (i in suffixes){
    for (j in 1:length(column)){
      word <- i
      if(word == substring(column[j],nchar(column[j])-nchar(word)+1,nchar(column[j]))){
        a = substring(column[j],1,nchar(column[j])-nchar(word))
        column[j] <- str_trim(a, "right")
      }
    }
  }
  return(column)
}

# endings to clean up
end_hs <- c("HS", "hs", "High Schoo.l", 
          "High School", "Hs", "Highschool",
          "H.s.", "High", "High-school",
          "H. S.", "H")

end_echs <- c("E C H S", "Echs", "Early College HS",
             "Early College High School", "Early College H S")

end_extra <- c("Faa", ", Reg. 16", ", Reg. 20w",
               "9", "/ Nisd",
               "Navarro I S D", "Killough", "ISD", "Isd")

vase$School <- re_string(vase$School, end_hs, " H S")
vase$School <- re_string(vase$School, end_echs, " ECHS")
vase$School <- un_string(vase$School, end_extra)
tea22$School <- re_string(tea22$School, end_echs, " ECHS")

sort(unique(vase$School))
```

**Key Value Linking**: Due to large size of `vase`, the dataset needs to be collapsed for fuzzy join to run quickly without overloading memory. However, quite a few schools have multiple, inconsistent formats in `vase`, such as not incorporating H S or other important school type identifiers. 

So a smaller dataframe will be created and joined with `tea`. Then `vase` will be joined with this dataframe, similar to a hash table.

```{r}

```